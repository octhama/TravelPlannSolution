<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             xmlns:converters="clr-namespace:Common.Converters"
             x:Class="TravelPlannMauiApp.Pages.MapPage"
             Title="Carte"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:StringToBoolConverter x:Key="StringToBoolConverter"/>
            <converters:TabSelectedConverter x:Key="TabSelectedConverter"/>
            <converters:TabTextColorConverter x:Key="TabTextColorConverter"/>
            <converters:StringNotEqualsConverter x:Key="StringNotEqualsConverter"/>
            <converters:StringStartsWithConverter x:Key="StringStartsWithConverter"/>
            <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
            <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
            <converters:DateToShortStringConverter x:Key="DateToShortStringConverter"/>
            <converters:PriceToStringConverter x:Key="PriceToStringConverter"/>
            <converters:TextTruncateConverter x:Key="TextTruncateConverter"/>
            <converters:CollectionCountConverter x:Key="CollectionCountConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Carte Microsoft Maps -->
        <maps:Map x:Name="MapControl" 
                  ZIndex="1"
                  IsShowingUser="False"
                  MapType="Street"
                  IsZoomEnabled="True"
                  IsScrollEnabled="True"
                  InputTransparent="False">
            <maps:Map.ItemTemplate>
                <DataTemplate>
                    <maps:Pin Location="{Binding Location}" 
                              Address="{Binding Address}" 
                              Label="{Binding Label}"
                              Type="Place"/>
                </DataTemplate>
            </maps:Map.ItemTemplate>
        </maps:Map>

        <!-- Barre de recherche en haut -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="25"
               HasShadow="True"
               Padding="15,10"
               VerticalOptions="Start"
               HorizontalOptions="Fill"
               Margin="20,70,20,0"
               ZIndex="2"
               InputTransparent="False">
            <Grid ColumnDefinitions="*,Auto">
                <Entry x:Name="SearchEntry"
                       Grid.Column="0"
                       Text="{Binding SearchQuery}"
                       Placeholder="Rechercher une destination..."
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                       PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#888888}"
                       FontSize="16"
                       ReturnCommand="{Binding SearchCommand}"/>
                <Button Grid.Column="1"
                        Text="ðŸ”"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="18"
                        Command="{Binding SearchCommand}"
                        WidthRequest="40"/>
            </Grid>
        </Frame>

        <!-- Boutons de contrÃ´le Ã  droite -->
        <VerticalStackLayout Spacing="10" 
                           HorizontalOptions="End" 
                           VerticalOptions="Center"
                           Margin="0,0,20,0"
                           ZIndex="2"
                           InputTransparent="False">

            <!-- Bouton Type de vue -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="{Binding ViewModeIcon}"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleViewModeCommand}"/>
            </Frame>

            <!-- Bouton Ma position - DÃ‰SACTIVÃ‰ -->
            <Frame BackgroundColor="{AppThemeBinding Light=#CCCCCC, Dark=#444444}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸ“"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                        FontSize="20"
                        IsEnabled="False"/>
            </Frame>

            <!-- Bouton Filtres -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸŽ¯"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleFiltersCommand}"/>
            </Frame>

            <!-- Bouton Liste des Ã©lÃ©ments -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸ“‹"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleItemsListCommand}"/>
            </Frame>
        </VerticalStackLayout>

        <!-- Panel de filtres -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="15"
               HasShadow="True"
               Padding="15"
               VerticalOptions="Start"
               HorizontalOptions="Start"
               Margin="20,140,0,0"
               WidthRequest="200"
               IsVisible="{Binding ShowFilters}"
               ZIndex="2"
               InputTransparent="False">
            <VerticalStackLayout Spacing="10">
                <Label Text="Afficher sur la carte" 
                       FontSize="14" 
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowAccommodations}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸ¨ HÃ©bergements" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowActivities}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸŽ¯ ActivitÃ©s" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowRestaurants}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸ½ï¸ Restaurants" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowTransport}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸš‡ Transports" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
            </VerticalStackLayout>
        </Frame>

        <!-- Panel d'informations en bas -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="15"
               HasShadow="True"
               Padding="20"
               VerticalOptions="End"
               HorizontalOptions="Fill"
               Margin="20,0,20,20"
               IsVisible="{Binding ShowLocationInfo}"
               ZIndex="2"
               InputTransparent="False">
            <VerticalStackLayout Spacing="10">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout Grid.Column="0">
                        <Label Text="{Binding SelectedLocationName}" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
                        <Label Text="{Binding SelectedLocationAddress}" 
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                        <Label Text="{Binding SelectedLocationDistance}" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    </VerticalStackLayout>
            
                    <Button Grid.Column="1"
                            Text="âœ•"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                            FontSize="16"
                            WidthRequest="30"
                            HeightRequest="30"
                            Command="{Binding CloseLocationInfoCommand}"/>
                </Grid>
        
                <ScrollView Orientation="Horizontal">
                    <StackLayout Orientation="Horizontal" Spacing="10">
                        <Button Text="ðŸ¨ HÃ©bergements"
                                BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                TextColor="White"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowAccommodationsCommand}"/>
                        <Button Text="ðŸŽ¯ ActivitÃ©s"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowActivitiesCommand}"/>
                        <Button Text="ðŸ½ï¸ Restaurants"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowRestaurantsCommand}"/>
                        <Button Text="ðŸ§­ ItinÃ©raire"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowDirectionsCommand}"/>
                    </StackLayout>
                </ScrollView>
            </VerticalStackLayout>
        </Frame>

        <!-- Panel de liste des Ã©lÃ©ments -->
<Frame IsVisible="{Binding ShowItemsList}" 
       ZIndex="2"
       VerticalOptions="Fill"
       HorizontalOptions="Fill"
       Margin="20"
       CornerRadius="15"
       HasShadow="True">
    
    <Grid RowDefinitions="Auto,*,Auto">
        <!-- En-tÃªte -->
        <Label Text="Mes Ã©lÃ©ments" 
               FontSize="16"
               FontAttributes="Bold"
               Margin="10"/>

        <!-- Onglets -->
        <StackLayout Grid.Row="0" Orientation="Horizontal" Spacing="0" Margin="10,0">
            <Button Text="Tout"
                    Command="{Binding SelectListTabCommand}"
                    CommandParameter="all"
                    BackgroundColor="{Binding SelectedListTab, Converter={StaticResource TabSelectedConverter}, ConverterParameter=all}"
                    TextColor="{Binding SelectedListTab, Converter={StaticResource TabTextColorConverter}, ConverterParameter=all}"
                    CornerRadius="5,0,0,5"/>
            <Button Text="ActivitÃ©s"
                    Command="{Binding SelectListTabCommand}"
                    CommandParameter="activities"
                    BackgroundColor="{Binding SelectedListTab, Converter={StaticResource TabSelectedConverter}, ConverterParameter=activities}"
                    TextColor="{Binding SelectedListTab, Converter={StaticResource TabTextColorConverter}, ConverterParameter=activities}"
                    CornerRadius="0"/>
            <Button Text="HÃ©bergements"
                    Command="{Binding SelectListTabCommand}"
                    CommandParameter="accommodations"
                    BackgroundColor="{Binding SelectedListTab, Converter={StaticResource TabSelectedConverter}, ConverterParameter=accommodations}"
                    TextColor="{Binding SelectedListTab, Converter={StaticResource TabTextColorConverter}, ConverterParameter=accommodations}"
                    CornerRadius="0,5,5,0"/>
        </StackLayout>

        <!-- Barre de recherche -->
        <Frame Grid.Row="0" Margin="10,40,10,0" Padding="10" CornerRadius="20" 
               BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#333333}">
            <Grid ColumnDefinitions="*,Auto">
                <Entry Text="{Binding ListSearchQuery}" 
                       Placeholder="Rechercher..."
                       BackgroundColor="Transparent"/>
                <Button Grid.Column="1" 
                        Text="âœ•" 
                        Command="{Binding ClearListSearchCommand}"
                        BackgroundColor="Transparent"/>
            </Grid>
        </Frame>

        <!-- Liste des activitÃ©s (visible selon l'onglet) -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding DisplayedActivities}"
                        IsVisible="{Binding ShowActivitiesList}"
                        SelectionMode="None"
                        Margin="10,50,10,0">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid ColumnDefinitions="*,Auto,Auto" Padding="10">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="{Binding Nom}" FontAttributes="Bold"/>
                            <Label Text="{Binding Localisation}" FontSize="Small"/>
                            <Label Text="{Binding VoyageNom}" FontSize="Small" TextColor="Gray"/>
                        </VerticalStackLayout>
                        
                        <Button Grid.Column="1"
                                Text="ðŸ—ºï¸"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:MapPage}}, Path=BindingContext.ShowActivityOnMapCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"/>
                                
                        <Button Grid.Column="2"
                                Text="âœ•"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:MapPage}}, Path=BindingContext.DeleteActivityCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"/>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Liste des hÃ©bergements (visible selon l'onglet) -->
        <CollectionView Grid.Row="1"
                        ItemsSource="{Binding DisplayedAccommodations}"
                        IsVisible="{Binding ShowAccommodationsList}"
                        SelectionMode="None"
                        Margin="10,50,10,0">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid ColumnDefinitions="*,Auto,Auto" Padding="10">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="{Binding Nom}" FontAttributes="Bold"/>
                            <Label Text="{Binding Adresse}" FontSize="Small"/>
                            <Label Text="{Binding VoyageNom}" FontSize="Small" TextColor="Gray"/>
                        </VerticalStackLayout>
                        
                        <Button Grid.Column="1"
                                Text="ðŸ—ºï¸"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:MapPage}}, Path=BindingContext.ShowAccommodationOnMapCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"/>
                                
                        <Button Grid.Column="2"
                                Text="âœ•"
                                Command="{Binding Source={RelativeSource AncestorType={x:Type local:MapPage}}, Path=BindingContext.DeleteAccommodationCommand}"
                                CommandParameter="{Binding .}"
                                BackgroundColor="Transparent"/>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Boutons d'action -->
        <Grid Grid.Row="2" ColumnDefinitions="*,*" Margin="10">
            <Button Grid.Column="0"
                    Text="Tout sÃ©lectionner"
                    Command="{Binding SelectAllItemsCommand}"
                    Margin="0,0,5,0"/>
                    
            <Button Grid.Column="1"
                    Text="Supprimer"
                    Command="{Binding DeleteSelectedItemsCommand}"
                    Margin="5,0,0,0"
                    IsEnabled="{Binding DisplayedActivities, Converter={StaticResource CollectionCountConverter}, ConverterParameter=selected}"/>
        </Grid>
    </Grid>
</Frame>

        <!-- Indicateur de chargement -->
        <ActivityIndicator IsVisible="{Binding IsLoading}"
                          IsRunning="{Binding IsLoading}"
                          Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                          ZIndex="3"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"
                          InputTransparent="True"/>

        <!-- Toast/Snackbar pour les messages -->
        <Frame BackgroundColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
               CornerRadius="20"
               Padding="15,10"
               VerticalOptions="End"
               HorizontalOptions="Center"
               Margin="20,20,20,100"
               IsVisible="{Binding ShowMessage}"
               ZIndex="4"
               InputTransparent="True">
            <Label Text="{Binding MessageText}"
                   TextColor="{AppThemeBinding Light=#FFFFFF, Dark=#333333}"
                   FontSize="14"/>
        </Frame>
    </Grid>
</ContentPage>