<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             xmlns:converters="clr-namespace:Common.Converters;assembly=Common"
             x:Class="TravelPlannMauiApp.Pages.MapPage"
             Title="Carte"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <ContentPage.Resources>
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:BoolToTextColorConverter x:Key="BoolToTextColorConverter" />
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
    </ContentPage.Resources>

    <Grid>
        <!-- Carte Microsoft Maps -->
        <maps:Map x:Name="MapControl" 
                  ZIndex="1"
                  IsShowingUser="False"
                  MapType="Street"
                  IsZoomEnabled="True"
                  IsScrollEnabled="True"
                  InputTransparent="False">
            <maps:Map.ItemTemplate>
                <DataTemplate>
                    <maps:Pin Location="{Binding Location}" 
                              Address="{Binding Address}" 
                              Label="{Binding Label}"
                              Type="Place"/>
                </DataTemplate>
            </maps:Map.ItemTemplate>
        </maps:Map>

        <!-- Overlay de contrÃ´les - SÃ‰PARÃ‰S POUR Ã‰VITER LES CONFLITS -->
        <!-- Pas de Grid global, chaque Ã©lÃ©ment est positionnÃ© individuellement -->
        <!-- Barre de recherche en haut -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="25"
               HasShadow="True"
               Padding="15,10"
               VerticalOptions="Start"
               HorizontalOptions="Fill"
               Margin="20,70,20,0"
               ZIndex="2"
               InputTransparent="False">
            <Grid ColumnDefinitions="*,Auto">
                <Entry x:Name="SearchEntry"
                       Grid.Column="0"
                       Text="{Binding SearchQuery}"
                       Placeholder="Rechercher une destination..."
                       BackgroundColor="Transparent"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                       PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#888888}"
                       FontSize="16"
                       ReturnCommand="{Binding SearchCommand}"/>
                <Button Grid.Column="1"
                        Text="ðŸ”"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="18"
                        Command="{Binding SearchCommand}"
                        WidthRequest="40"/>
            </Grid>
        </Frame>

        <!-- Boutons de contrÃ´le Ã  droite -->
        <VerticalStackLayout Spacing="10" 
                           HorizontalOptions="End" 
                           VerticalOptions="Center"
                           Margin="0,0,20,0"
                           ZIndex="2"
                           InputTransparent="False">
    
            <!-- Bouton Style de carte 
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="{Binding MapStyleIcon}"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleMapStyleCommand}"/>
            </Frame>-->

            <!-- Bouton Type de vue -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="{Binding ViewModeIcon}"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleViewModeCommand}"/>
            </Frame>

            <!-- Bouton Ma position - DÃ‰SACTIVÃ‰ -->
            <Frame BackgroundColor="{AppThemeBinding Light=#CCCCCC, Dark=#444444}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸ“"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#999999, Dark=#666666}"
                        FontSize="20"
                        IsEnabled="False"/>
            </Frame>

            <!-- Bouton Filtres -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸŽ¯"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding ToggleFiltersCommand}"/>
            </Frame>

            <!-- Bouton Gestion des lieux -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="20"
                   HasShadow="True"
                   Padding="0"
                   WidthRequest="50"
                   HeightRequest="50"
                   InputTransparent="False">
                <Button Text="ðŸ“‹"
                        BackgroundColor="Transparent"
                        TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        FontSize="20"
                        Command="{Binding TogglePOIManagementCommand}"/>
            </Frame>

        </VerticalStackLayout>

        <!-- Panel de filtres -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="15"
               HasShadow="True"
               Padding="15"
               VerticalOptions="Start"
               HorizontalOptions="Start"
               Margin="20,140,0,0"
               WidthRequest="200"
               IsVisible="{Binding ShowFilters}"
               ZIndex="2"
               InputTransparent="False">
            <VerticalStackLayout Spacing="10">
                <Label Text="Afficher sur la carte" 
                       FontSize="14" 
                       FontAttributes="Bold"
                       TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowAccommodations}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸ¨ HÃ©bergements" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowActivities}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸŽ¯ ActivitÃ©s" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowRestaurants}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸ½ï¸ Restaurants" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
        
                <StackLayout Orientation="Horizontal">
                    <CheckBox IsChecked="{Binding ShowTransport}" 
                              Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    <Label Text="ðŸš‡ Transports" 
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           VerticalOptions="Center"/>
                </StackLayout>
            </VerticalStackLayout>
        </Frame>

        <!-- Panel de gestion des POI -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="15"
               HasShadow="True"
               Padding="15"
               VerticalOptions="Fill"
               HorizontalOptions="End"
               Margin="0,70,20,20"
               WidthRequest="300"
               IsVisible="{Binding ShowPOIManagement}"
               ZIndex="2"
               InputTransparent="False">
            <ScrollView>
                <VerticalStackLayout Spacing="15">
                    <!-- En-tÃªte avec bouton fermer -->
                    <Grid ColumnDefinitions="*,Auto">
                        <Label Grid.Column="0"
                               Text="Gestion des lieux" 
                               FontSize="16" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                               VerticalOptions="Center"/>
                        <Button Grid.Column="1"
                                Text="âœ•"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                FontSize="16"
                                WidthRequest="30"
                                HeightRequest="30"
                                Command="{Binding ClosePOIManagementCommand}"/>
                    </Grid>

                    <!-- Onglets -->
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="5">
                        <Button Grid.Column="0"
                                Text="ðŸ¨ HÃ©bergements"
                                BackgroundColor="{Binding POITabAccommodations, Converter={StaticResource BoolToColorConverter}}"
                                TextColor="{Binding POITabAccommodations, Converter={StaticResource BoolToTextColorConverter}}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="10"
                                Padding="10,8"
                                Command="{Binding SwitchPOITabCommand}"
                                CommandParameter="accommodations"/>
                        <Button Grid.Column="1"
                                Text="ðŸŽ¯ ActivitÃ©s"
                                BackgroundColor="{Binding POITabActivities, Converter={StaticResource BoolToColorConverter}}"
                                TextColor="{Binding POITabActivities, Converter={StaticResource BoolToTextColorConverter}}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="10"
                                Padding="10,8"
                                Command="{Binding SwitchPOITabCommand}"
                                CommandParameter="activities"/>
                    </Grid>

                    <!-- Liste des hÃ©bergements -->
                    <VerticalStackLayout IsVisible="{Binding POITabAccommodations}" Spacing="8">
                        <Label Text="{Binding AccommodationsCount, StringFormat='{0} hÃ©bergement(s)'}" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                        
                        <CollectionView ItemsSource="{Binding AccommodationsList}"
                                        HeightRequest="300">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*,Auto" 
                                          Padding="8"
                                          BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}"
                                          Margin="0,2">
                                        <Label Grid.Column="0"
                                               Text="ðŸ¨"
                                               FontSize="14"
                                               VerticalOptions="Center"
                                               Margin="0,0,8,0"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding Nom}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation"/>
                                        <Button Grid.Column="2"
                                                Text="âœ•"
                                                BackgroundColor="Transparent"
                                                TextColor="#FF4444"
                                                FontSize="16"
                                                WidthRequest="30"
                                                HeightRequest="30"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteAccommodationCommand}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Liste des activitÃ©s -->
                    <VerticalStackLayout IsVisible="{Binding POITabActivities}" Spacing="8">
                        <Label Text="{Binding ActivitiesCount, StringFormat='{0} activitÃ©(s)'}" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                        
                        <CollectionView ItemsSource="{Binding ActivitiesList}"
                                        HeightRequest="300">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="Auto,*,Auto" 
                                          Padding="8"
                                          BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#2A2A2A}"
                                          Margin="0,2">
                                        <Label Grid.Column="0"
                                               Text="ðŸŽ¯"
                                               FontSize="14"
                                               VerticalOptions="Center"
                                               Margin="0,0,8,0"/>
                                        <Label Grid.Column="1"
                                               Text="{Binding Nom}"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                                               VerticalOptions="Center"
                                               LineBreakMode="TailTruncation"/>
                                        <Button Grid.Column="2"
                                                Text="âœ•"
                                                BackgroundColor="Transparent"
                                                TextColor="#FF4444"
                                                FontSize="16"
                                                WidthRequest="30"
                                                HeightRequest="30"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteActivityCommand}"
                                                CommandParameter="{Binding}"/>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>

                    <!-- Message d'Ã©tat -->
                    <Label Text="{Binding POIManagementMessage}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                           HorizontalTextAlignment="Center"
                           IsVisible="{Binding POIManagementMessage, Converter={StaticResource StringToBoolConverter}}"/>

                </VerticalStackLayout>
            </ScrollView>
        </Frame>

        <!-- Panel d'informations en bas -->
        <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
               CornerRadius="15"
               HasShadow="True"
               Padding="20"
               VerticalOptions="End"
               HorizontalOptions="Fill"
               Margin="20,0,20,20"
               IsVisible="{Binding ShowLocationInfo}"
               ZIndex="2"
               InputTransparent="False">
            <VerticalStackLayout Spacing="10">
                <Grid ColumnDefinitions="*,Auto">
                    <VerticalStackLayout Grid.Column="0">
                        <Label Text="{Binding SelectedLocationName}" 
                               FontSize="18" 
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
                        <Label Text="{Binding SelectedLocationAddress}" 
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                        <Label Text="{Binding SelectedLocationDistance}" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                    </VerticalStackLayout>
            
                    <Button Grid.Column="1"
                            Text="âœ•"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                            FontSize="16"
                            WidthRequest="30"
                            HeightRequest="30"
                            Command="{Binding CloseLocationInfoCommand}"/>
                </Grid>
        
                <ScrollView Orientation="Horizontal">
                    <StackLayout Orientation="Horizontal" Spacing="10">
                        <Button Text="ðŸ¨ HÃ©bergements"
                                BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                TextColor="White"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowAccommodationsCommand}"/>
                        <Button Text="ðŸŽ¯ ActivitÃ©s"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowActivitiesCommand}"/>
                        <Button Text="ðŸ½ï¸ Restaurants"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowRestaurantsCommand}"/>
                        <Button Text="ðŸ§­ ItinÃ©raire"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                BorderWidth="1"
                                FontSize="12"
                                CornerRadius="15"
                                Padding="15,8"
                                Command="{Binding ShowDirectionsCommand}"/>
                    </StackLayout>
                </ScrollView>
            </VerticalStackLayout>
        </Frame>

        <!-- Indicateur de chargement -->
        <ActivityIndicator IsVisible="{Binding IsLoading}"
                          IsRunning="{Binding IsLoading}"
                          Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                          ZIndex="3"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"
                          InputTransparent="True"/>

        <!-- Toast/Snackbar pour les messages -->
        <Frame BackgroundColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
               CornerRadius="20"
               Padding="15,10"
               VerticalOptions="End"
               HorizontalOptions="Center"
               Margin="20,20,20,100"
               IsVisible="{Binding ShowMessage}"
               ZIndex="4"
               InputTransparent="True">
            <Label Text="{Binding MessageText}"
                   TextColor="{AppThemeBinding Light=#FFFFFF, Dark=#333333}"
                   FontSize="14"/>
        </Frame>

    </Grid>
</ContentPage>