<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             x:Class="TravelPlannMauiApp.Pages.MapPage"
             Title="Carte"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <Grid>
        <!-- Carte Microsoft Maps -->
        <maps:Map x:Name="MapControl" 
                  ZIndex="1"
                  IsShowingUser="True"
                  MapType="Street"
                  IsZoomEnabled="True"
                  IsScrollEnabled="True"
                  InputTransparent="False">
            <maps:Map.ItemTemplate>
                <DataTemplate>
                    <maps:Pin Location="{Binding Location}" 
                              Address="{Binding Address}" 
                              Label="{Binding Label}"
                              Type="Place"/>
                </DataTemplate>
            </maps:Map.ItemTemplate>
        </maps:Map>

        <!-- Overlay de contrÃ´les -->
        <Grid ZIndex="2" Margin="20" InputTransparent="True">
            
            <!-- Barre de recherche en haut -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="25"
                   HasShadow="True"
                   Padding="15,10"
                   VerticalOptions="Start"
                   HorizontalOptions="Fill"
                   Margin="0,50,0,0"
                   InputTransparent="False">
                <Grid ColumnDefinitions="*,Auto">
                    <Entry x:Name="SearchEntry"
                           Grid.Column="0"
                           Text="{Binding SearchQuery}"
                           Placeholder="Rechercher une destination..."
                           BackgroundColor="Transparent"
                           TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
                           PlaceholderColor="{AppThemeBinding Light=#999999, Dark=#888888}"
                           FontSize="16"
                           ReturnCommand="{Binding SearchCommand}"/>
                    <Button Grid.Column="1"
                            Text="ðŸ”"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                            FontSize="18"
                            Command="{Binding SearchCommand}"
                            WidthRequest="40"/>
                </Grid>
            </Frame>

            <!-- Boutons de contrÃ´le Ã  droite -->
            <VerticalStackLayout Spacing="10" 
                               HorizontalOptions="End" 
                               VerticalOptions="Center"
                               InputTransparent="False">
                
                <!-- Bouton Style de carte -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                       CornerRadius="20"
                       HasShadow="True"
                       Padding="0"
                       WidthRequest="50"
                       HeightRequest="50">
                    <Button Text="{Binding MapStyleIcon}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                            FontSize="20"
                            Command="{Binding ToggleMapStyleCommand}"/>
                </Frame>

                <!-- Bouton Type de vue -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                       CornerRadius="20"
                       HasShadow="True"
                       Padding="0"
                       WidthRequest="50"
                       HeightRequest="50">
                    <Button Text="{Binding ViewModeIcon}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                            FontSize="20"
                            Command="{Binding ToggleViewModeCommand}"/>
                </Frame>

                <!-- Bouton Ma position -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                       CornerRadius="20"
                       HasShadow="True"
                       Padding="0"
                       WidthRequest="50"
                       HeightRequest="50">
                    <Button Text="ðŸ“"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                            FontSize="20"
                            Command="{Binding GoToMyLocationCommand}"/>
                </Frame>

                <!-- Bouton Filtres -->
                <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                       CornerRadius="20"
                       HasShadow="True"
                       Padding="0"
                       WidthRequest="50"
                       HeightRequest="50">
                    <Button Text="ðŸŽ¯"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                            FontSize="20"
                            Command="{Binding ToggleFiltersCommand}"/>
                </Frame>

            </VerticalStackLayout>

            <!-- Panel de filtres -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="15"
                   HasShadow="True"
                   Padding="15"
                   VerticalOptions="Start"
                   HorizontalOptions="Start"
                   Margin="0,120,0,0"
                   WidthRequest="200"
                   IsVisible="{Binding ShowFilters}"
                   InputTransparent="False">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Afficher sur la carte" 
                           FontSize="14" 
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
                    
                    <StackLayout Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding ShowAccommodations}" 
                                  Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        <Label Text="ðŸ¨ HÃ©bergements" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               VerticalOptions="Center"/>
                    </StackLayout>
                    
                    <StackLayout Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding ShowActivities}" 
                                  Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        <Label Text="ðŸŽ¯ ActivitÃ©s" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               VerticalOptions="Center"/>
                    </StackLayout>
                    
                    <StackLayout Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding ShowRestaurants}" 
                                  Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        <Label Text="ðŸ½ï¸ Restaurants" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               VerticalOptions="Center"/>
                    </StackLayout>
                    
                    <StackLayout Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding ShowTransport}" 
                                  Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        <Label Text="ðŸš‡ Transports" 
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                               VerticalOptions="Center"/>
                    </StackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Panel d'informations en bas -->
            <Frame BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   CornerRadius="15"
                   HasShadow="True"
                   Padding="20"
                   VerticalOptions="End"
                   HorizontalOptions="Fill"
                   IsVisible="{Binding ShowLocationInfo}"
                   InputTransparent="False">
                <VerticalStackLayout Spacing="10">
                    <Grid ColumnDefinitions="*,Auto">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="{Binding SelectedLocationName}" 
                                   FontSize="18" 
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"/>
                            <Label Text="{Binding SelectedLocationAddress}" 
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                            <Label Text="{Binding SelectedLocationDistance}" 
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        </VerticalStackLayout>
                        
                        <Button Grid.Column="1"
                                Text="âœ•"
                                BackgroundColor="Transparent"
                                TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                FontSize="16"
                                WidthRequest="30"
                                HeightRequest="30"
                                Command="{Binding CloseLocationInfoCommand}"/>
                    </Grid>
                    
                    <ScrollView Orientation="Horizontal">
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Button Text="ðŸ¨ HÃ©bergements"
                                    BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    TextColor="White"
                                    FontSize="12"
                                    CornerRadius="15"
                                    Padding="15,8"
                                    Command="{Binding ShowAccommodationsCommand}"/>
                            <Button Text="ðŸŽ¯ ActivitÃ©s"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderWidth="1"
                                    FontSize="12"
                                    CornerRadius="15"
                                    Padding="15,8"
                                    Command="{Binding ShowActivitiesCommand}"/>
                            <Button Text="ðŸ½ï¸ Restaurants"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderWidth="1"
                                    FontSize="12"
                                    CornerRadius="15"
                                    Padding="15,8"
                                    Command="{Binding ShowRestaurantsCommand}"/>
                            <Button Text="ðŸ§­ ItinÃ©raire"
                                    BackgroundColor="Transparent"
                                    TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                    BorderWidth="1"
                                    FontSize="12"
                                    CornerRadius="15"
                                    Padding="15,8"
                                    Command="{Binding ShowDirectionsCommand}"/>
                        </StackLayout>
                    </ScrollView>
                </VerticalStackLayout>
            </Frame>

        </Grid>

        <!-- Indicateur de chargement -->
        <ActivityIndicator IsVisible="{Binding IsLoading}"
                          IsRunning="{Binding IsLoading}"
                          Color="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                          ZIndex="3"
                          VerticalOptions="Center"
                          HorizontalOptions="Center"/>

        <!-- Toast/Snackbar pour les messages -->
        <Frame BackgroundColor="{AppThemeBinding Light=#333333, Dark=#FFFFFF}"
               CornerRadius="20"
               Padding="15,10"
               VerticalOptions="End"
               HorizontalOptions="Center"
               Margin="20,20,20,100"
               IsVisible="{Binding ShowMessage}"
               ZIndex="4">
            <Label Text="{Binding MessageText}"
                   TextColor="{AppThemeBinding Light=#FFFFFF, Dark=#333333}"
                   FontSize="14"/>
        </Frame>

    </Grid>
</ContentPage>