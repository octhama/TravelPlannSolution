<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:sys="clr-namespace:System;assembly=System.Runtime"
             xmlns:converters="clr-namespace:Common.Converters;assembly=Common"
             xmlns:vm="clr-namespace:TravelPlannMauiApp.ViewModels"
             x:Class="TravelPlannMauiApp.Pages.VoyageDetailsPage"
             Title="Détails du voyage"
             BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#121212}">

    <ContentPage.Resources>
        <converters:DateOnlyToDateTimeConverter x:Key="DateOnlyToDateTimeConverter"/>
        <converters:InverseBoolConverter x:Key="InverseBool"/>
        <converters:DecimalToEuroConverter x:Key="DecimalToEuro"/>
        <converters:StringToVisibilityConverter x:Key="StringToVisibility"/>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="15" Spacing="10">
            
            <!-- Carte (réduite) -->
            <Frame HeightRequest="100" CornerRadius="10" Padding="0"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HasShadow="True">
                <Image Source="#" Aspect="AspectFill"/>
            </Frame>

            <!-- Mode Affichage -->
            <Frame IsVisible="{Binding IsViewMode}"
                   CornerRadius="10" Padding="10"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HasShadow="True">
                <VerticalStackLayout Spacing="8">
                    <Label Text="{Binding NomVoyage}" FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                    
                    <Label Text="{Binding Description}" FontSize="13"
                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"/>
                    
                    <Grid ColumnDefinitions="*,*" Margin="0,5">
                        <Label Text="{Binding DateDebut, StringFormat='Début: {0:dd/MM/yyyy}'}"
                               FontSize="11"
                               TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>
                        
                        <Label Grid.Column="1"
                               Text="{Binding DateFin, StringFormat='Fin: {0:dd/MM/yyyy}'}"
                               FontSize="11"
                               TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                               HorizontalOptions="End"/>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

             <!-- Mode Édition -->
            <Frame IsVisible="{Binding IsEditMode}"
                   CornerRadius="10" Padding="10"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Entry Text="{Binding NomVoyage}" Placeholder="Nom du voyage"
                           FontSize="15"
                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                    
                    <Editor Text="{Binding Description}" Placeholder="Description"
                           AutoSize="TextChanges" HeightRequest="80"
                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                    
                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                        <VerticalStackLayout Spacing="3">
                            <Label Text="Date de début" FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                            <DatePicker Date="{Binding DateDebut, Converter={StaticResource DateOnlyToDateTimeConverter}}"
                                       MinimumDate="{x:Static sys:DateTime.Today}"
                                       FontSize="13"/>
                        </VerticalStackLayout>
                        
                        <VerticalStackLayout Grid.Column="1" Spacing="3">
                            <Label Text="Date de fin" FontSize="12"
                                   TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                            <DatePicker Date="{Binding DateFin, Converter={StaticResource DateOnlyToDateTimeConverter}}"
                                       MinimumDate="{Binding DateDebut}"
                                       FontSize="13"/>
                        </VerticalStackLayout>
                    </Grid>

                    <!-- Section Activités (visible uniquement en mode édition) -->
                    <Frame Padding="10"
                           BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#252525}"
                           CornerRadius="8">
                        <VerticalStackLayout Spacing="10">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Activités"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                <Label Grid.Column="1" 
                                       Text="📍"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                            </Grid>

                            <!-- Formulaire d'ajout d'activité -->
                            <Frame IsVisible="{Binding ShowActiviteForm}"
                                   Padding="8"
                                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                   CornerRadius="6">
                                <VerticalStackLayout Spacing="6">
                                    <Entry Text="{Binding NouvelleActiviteNom}" 
                                           Placeholder="Nom de l'activité"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                           
                                    <Editor Text="{Binding NouvelleActiviteDescription}"
                                            Placeholder="Description"
                                            HeightRequest="60"
                                            FontSize="14"
                                            TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>

                                    <!-- NOUVEAU : Champ Localisation -->
                                    <Entry Text="{Binding NouvelleActiviteLocalisation}"
                                           Placeholder="📍 Localisation"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                            
                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                        <Button Text="Annuler" 
                                                Command="{Binding AnnulerAjoutActiviteCommand}"
                                                BackgroundColor="#CCCCCC"
                                                FontSize="12"
                                                HeightRequest="35"
                                                TextColor="Black"/>
                                                
                                        <Button Grid.Column="1" 
                                                Text="Ajouter"
                                                Command="{Binding AjouterNouvelleActiviteCommand}"
                                                BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                                FontSize="12"
                                                HeightRequest="35"
                                                TextColor="White"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>

                            <!-- Bouton pour afficher le formulaire -->
                            <Button Text="+ Ajouter une activité"
                                    Command="{Binding AjouterActiviteCommand}"
                                    IsVisible="{Binding ShowActiviteForm, Converter={StaticResource InverseBool}}"
                                    BackgroundColor="Transparent"
                                    FontSize="12"
                                    HeightRequest="30"
                                    TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>

                            <!-- Liste des activités avec bouton de suppression -->
                            <CollectionView ItemsSource="{Binding Activites}"
                                   HeightRequest="120">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto">
                                    <!-- Nom -->
                                    <Label Text="{Binding Nom}"
                                           FontAttributes="Bold"
                                           FontSize="13"
                                           VerticalOptions="Start"/>
                                    
                                    <!-- Description -->
                                    <Label Grid.Row="1"
                                           Text="{Binding Description}"
                                           FontAttributes="Italic"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                           IsVisible="{Binding Description, Converter={StaticResource StringToVisibility}}"
                                           VerticalOptions="Start"/>
                                    
                                    <!-- NOUVEAU : Localisation -->
                                    <Label Grid.Row="2"
                                           Text="{Binding Localisation, StringFormat='📍 {0}'}"
                                           FontSize="10"
                                           TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                           IsVisible="{Binding Localisation, Converter={StaticResource StringToVisibility}}"
                                           VerticalOptions="Start"/>
                                    
                                    <!-- Bouton supprimer -->
                                    <Button Grid.Column="1" 
                                            Grid.RowSpan="3"
                                            Text="×"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:VoyageDetailsViewModel}}, Path=SupprimerActiviteCommand}"
                                            CommandParameter="{Binding}"
                                            BackgroundColor="Transparent"
                                            TextColor="Red"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            WidthRequest="30"
                                            HeightRequest="30"
                                            VerticalOptions="Center"
                                            HorizontalOptions="End"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Section Hébergements (visible uniquement en mode édition) -->
                    <Frame Padding="10"
                           BackgroundColor="{AppThemeBinding Light=#F8F8F8, Dark=#252525}"
                           CornerRadius="8">
                        <VerticalStackLayout Spacing="10">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Hébergements"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                <Label Grid.Column="1" 
                                       Text="🏠"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                            </Grid>

                            <!-- Formulaire d'ajout d'hébergement -->
                            <Frame IsVisible="{Binding ShowHebergementForm}"
                                   Padding="8"
                                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                                   CornerRadius="6">
                                <VerticalStackLayout Spacing="6">
                                    <Entry Text="{Binding NouvelHebergementNom}" 
                                           Placeholder="Nom de l'hébergement"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                           
                                    <Entry Text="{Binding NouvelHebergementType}"
                                           Placeholder="Type (Hôtel, Airbnb...)"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>

                                    <!-- NOUVEAU : Champ Adresse -->
                                    <Entry Text="{Binding NouvelHebergementAdresse}"
                                           Placeholder="🏠 Adresse complète"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                           
                                    <Entry Text="{Binding NouvelHebergementCout}"
                                           Placeholder="Coût par nuit (€)"
                                           Keyboard="Numeric"
                                           FontSize="14"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                            
                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="8">
                                        <Button Text="Annuler" 
                                                Command="{Binding AnnulerAjoutHebergementCommand}"
                                                BackgroundColor="#CCCCCC"
                                                FontSize="12"
                                                HeightRequest="35"
                                                TextColor="Black"/>
                                                
                                        <Button Grid.Column="1" 
                                                Text="Ajouter"
                                                Command="{Binding AjouterNouvelHebergementCommand}"
                                                BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                                FontSize="12"
                                                HeightRequest="35"
                                                TextColor="White"/>
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>

                            <!-- Bouton pour afficher le formulaire -->
                            <Button Text="+ Ajouter un hébergement"
                                    Command="{Binding AjouterHebergementCommand}"
                                    IsVisible="{Binding ShowHebergementForm, Converter={StaticResource InverseBool}}"
                                    BackgroundColor="Transparent"
                                    FontSize="12"
                                    HeightRequest="30"
                                    TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"/>

                            <!-- Liste des hébergements avec bouton de suppression -->
                            <CollectionView ItemsSource="{Binding Hebergements}"
                                   HeightRequest="120">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnDefinitions="2*,*,*,Auto" RowDefinitions="Auto,Auto,Auto">
                                    <!-- Nom et type -->
                                    <Label Text="{Binding Nom}"
                                           FontAttributes="Bold"
                                           FontSize="13"
                                           VerticalOptions="Start"/>
                                    
                                    <Label Grid.Column="1" 
                                           Text="{Binding TypeHebergement}"
                                           FontAttributes="Italic"
                                           FontSize="11"
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"
                                           IsVisible="{Binding TypeHebergement, Converter={StaticResource StringToVisibility}}"
                                           VerticalOptions="Start"/>
                                    
                                    <Label Grid.Column="2" 
                                           Text="{Binding Cout, Converter={StaticResource DecimalToEuro}}"
                                           TextColor="Green"
                                           FontAttributes="Bold"
                                           FontSize="12"
                                           VerticalOptions="Start"/>

                                    <!-- NOUVEAU : Adresse -->
                                    <Label Grid.Row="1"
                                           Grid.ColumnSpan="3"
                                           Text="{Binding Adresse, StringFormat='🏠 {0}'}"
                                           FontSize="10"
                                           TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                           IsVisible="{Binding Adresse, Converter={StaticResource StringToVisibility}}"
                                           VerticalOptions="Start"/>
                                    
                                    <!-- Bouton supprimer -->
                                    <Button Grid.Column="3" 
                                            Grid.RowSpan="3"
                                            Text="×"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:VoyageDetailsViewModel}}, Path=SupprimerHebergementCommand}"
                                            CommandParameter="{Binding}"
                                            BackgroundColor="Transparent"
                                            TextColor="Red"
                                            FontSize="14"
                                            FontAttributes="Bold"
                                            WidthRequest="30"
                                            HeightRequest="30"
                                            VerticalOptions="Center"
                                            HorizontalOptions="End"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>
            </Frame>

            <!-- Section Activités (affichage seul) - AMÉLIORÉE -->
            <Frame IsVisible="{Binding IsViewMode}"
                   CornerRadius="10" Padding="10"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HasShadow="True">
                <StackLayout>
                    <Grid ColumnDefinitions="*,Auto" Margin="5,0">
                        <Label Text="Activités" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                        <Label Grid.Column="1" 
                               Text="📍"
                               FontSize="16"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                    </Grid>
                    
                    <CollectionView ItemsSource="{Binding Activites}" HeightRequest="150">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="10" RowDefinitions="Auto,Auto,Auto">
                                    <!-- Nom -->
                                    <Label Text="{Binding Nom}" 
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                    
                                    <!-- Description -->
                                    <Label Grid.Row="1"
                                           Text="{Binding Description}"
                                           FontSize="13" 
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"
                                           IsVisible="{Binding Description, Converter={StaticResource StringToVisibility}}"
                                           Margin="0,2,0,0"/>
                                    
                                    <!-- NOUVEAU : Localisation -->
                                    <Label Grid.Row="2"
                                           Text="{Binding Localisation, StringFormat='📍 {0}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                           IsVisible="{Binding Localisation, Converter={StaticResource StringToVisibility}}"
                                           Margin="0,2,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Frame>

            <!-- Section Hébergements (affichage seul) - AMÉLIORÉE -->
            <Frame IsVisible="{Binding IsViewMode}"
                   CornerRadius="10" Padding="10"
                   BackgroundColor="{AppThemeBinding Light=White, Dark=#1E1E1E}"
                   HasShadow="True">
                <StackLayout>
                    <Grid ColumnDefinitions="*,Auto" Margin="5,0">
                        <Label Text="Hébergements" 
                               FontAttributes="Bold" 
                               FontSize="16"
                               TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                        <Label Grid.Column="1" 
                               Text="🏠"
                               FontSize="16"
                               TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}"/>
                    </Grid>
                    
                    <CollectionView ItemsSource="{Binding Hebergements}" HeightRequest="150">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="10" ColumnDefinitions="2*,*,*" RowDefinitions="Auto,Auto,Auto">
                                    <!-- Nom -->
                                    <Label Text="{Binding Nom}" 
                                           FontSize="15"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#333333, Dark=White}"/>
                                    
                                    <!-- Type -->
                                    <Label Grid.Column="1" 
                                           Text="{Binding TypeHebergement}"
                                           FontSize="13" 
                                           TextColor="{AppThemeBinding Light=#666666, Dark=#CCCCCC}"
                                           IsVisible="{Binding TypeHebergement, Converter={StaticResource StringToVisibility}}"/>
                                    
                                    <!-- Prix -->
                                    <Label Grid.Column="2" 
                                           Text="{Binding Cout, Converter={StaticResource DecimalToEuro}}"
                                           FontSize="14" 
                                           FontAttributes="Bold"
                                           TextColor="Green"/>
                                    
                                    <!-- NOUVEAU : Adresse -->
                                    <Label Grid.Row="1"
                                           Grid.ColumnSpan="3"
                                           Text="{Binding Adresse, StringFormat='🏠 {0}'}"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                                           IsVisible="{Binding Adresse, Converter={StaticResource StringToVisibility}}"
                                           Margin="0,2,0,0"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>
            </Frame>

            <!-- Boutons -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="8" Margin="0,5">
                <Button Text="Modifier" 
                        Command="{Binding ToggleEditCommand}"
                        IsVisible="{Binding IsViewMode}"
                        CornerRadius="6"
                        HeightRequest="40"
                        FontSize="13"
                        BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        TextColor="White"/>
                
                <Button Grid.Column="1" 
                        Text="Supprimer" 
                        Command="{Binding DeleteCommand}"
                        IsVisible="{Binding IsViewMode}"
                        CornerRadius="6"
                        HeightRequest="40"
                        FontSize="13"
                        BackgroundColor="#FF4444"
                        TextColor="White"/>

                <Button Text="Annuler" 
                        Command="{Binding CancelEditCommand}"
                        IsVisible="{Binding IsEditMode}"
                        CornerRadius="6"
                        HeightRequest="40"
                        FontSize="13"
                        BackgroundColor="#CCCCCC"
                        TextColor="Black"/>
                
                <Button Grid.Column="1" 
                        Text="Enregistrer"
                        Command="{Binding SaveCommand}"
                        IsVisible="{Binding IsEditMode}"
                        CornerRadius="6"
                        HeightRequest="40"
                        FontSize="13"
                        BackgroundColor="{AppThemeBinding Light=#6200EE, Dark=#BB86FC}"
                        TextColor="White"/>
            </Grid>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>